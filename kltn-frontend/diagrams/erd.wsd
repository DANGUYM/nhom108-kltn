@startuml Instrument_Service_ERD

title ERD for Instrument Service (MongoDB Collections)

' Simple formatting for standard ERD
!define PK(x) <b>PK</b> x
!define FK(x) <i>FK</i> x

' -------------------------------------------------------------------
' Core Entities
' -------------------------------------------------------------------

entity Instrument_Model {
    PK(Model_ID) : String
    --
    Model_Name : String
    Manufacturer : String
    Model_Version : String
    Supported_Test_Types : Array[String]
    Technical_Specifications : Object
    Default_Configuration : Object
    Created_Date : DateTime
    Updated_Date : DateTime
}

entity Instrument {
    PK(Instrument_ID) : String
    --
    FK(Model_ID) : String
    Serial_Number : String
    Installation_Date : DateTime
    Current_Mode : Enum[Ready, Maintenance, Inactive]
    Last_Mode_Change_TS : DateTime
    Location : String
    Maintenance_Schedule : Object
    QC_Status : Enum[Passed, Failed, Pending, NotRequired]
    Is_Active : Boolean
    Memory_Usage_Percent : Number
    Status : Enum[Available, Busy, Error]
    Created_Date : DateTime
    Updated_Date : DateTime
}


' -------------------------------------------------------------------
' Test Results Management
' -------------------------------------------------------------------

entity Raw_Test_Result {
    PK(Result_ID) : String
    --
    FK(Instrument_ID) : String
    Test_Order_ID : String
    Sample_Barcode : String
    Raw_HL7_Message : String
    Analysis_Start_TS : DateTime
    Analysis_Completion_TS : DateTime
    Result_Status : Enum[Completed, Processing, Failed, Pending]
    Quality_Flags : Array[String]
    Publish_Status : Enum[Sent, Failed, Pending]
    Is_Backup_Stored : Boolean
    Memory_Size_KB : Number
    Created_Date : DateTime
}


' -------------------------------------------------------------------
' Reagents Management
' -------------------------------------------------------------------


entity Instrument_Reagent {
    PK(Assignment_ID) : String
    --
    FK(Instrument_ID) : String
    FK(Reagent_ID) : String
    Installation_Date : DateTime
    Position_Slot : String
    Status : Enum[Installed, Removed, Expired, LowLevel]
    Expected_Tests_Count : Number
    Actual_Tests_Count : Number
    Low_Level_Threshold : Number
    Sufficient_Level : Boolean
    Created_Date : DateTime
    Updated_Date : DateTime
}

' -------------------------------------------------------------------
' Configuration Management
' -------------------------------------------------------------------

entity Configuration_Profile {
    PK(Profile_ID) : String
    --
    Profile_Name : String
    Profile_Type : Enum[General, Specific]
    Configuration_Data : Object
    Is_Global : Boolean
    Target_Model_ID : String
    Target_Device_Type : String
    Version : String
    Firmware_Version : String
    Calibration_Settings : Object
    Created_By : String
    Created_Date : DateTime
    Updated_Date : DateTime
    Is_Active : Boolean
}

entity Configuration_Sync_Log {
    PK(Sync_Log_ID) : String
    --
    FK(Instrument_ID) : String
    FK(Profile_ID) : String
    User_Performed : String
    Sync_Timestamp : DateTime
    Sync_Type : Enum[General, Specific, Both]
    Sync_Status : Enum[Success, Failed, Partial]
    Error_Details : String
    Configuration_Hash : String
    Rollback_Data : Object
    Device_Type_Validated : Boolean
    General_Config_Applied : Boolean
    Specific_Config_Applied : Boolean
    Processing_Time_MS : Number
}

' -------------------------------------------------------------------
' Relationships
' -------------------------------------------------------------------

Instrument_Model ||--o{ Instrument : defines
Instrument_Model ||--o{ Configuration_Profile : targets

Instrument ||--o{ Raw_Test_Result : generates_results
Instrument ||--o{ Configuration_Sync_Log : syncs_configuration
Instrument ||--o{ Instrument_Reagent : uses_reagents

Configuration_Profile ||--o{ Configuration_Sync_Log : applied_via_sync

@enduml